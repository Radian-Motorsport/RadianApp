<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Map - Radian</title>
  <!-- External Dependencies -->
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="trackmap-overlay.css">
</head>
<body>
  <!-- Top Bar -->
  <div id="topBar" class="top-bar"></div>

  <!-- Track Map -->
  <div class="telemetry-block">
    <h2>Track Map</h2>
    
    <!-- Track Selector -->
    <div class="track-selector-container" style="margin-bottom: 15px;">
      <label for="trackSelector" style="color: #ffffff; margin-right: 10px; font-weight: bold;">Track:</label>
      <select id="trackSelector" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: #ffffff; font-size: 14px;">
        <option value="ring-vln">Ring VLN (N√ºrburgring)</option>
        <option value="indianapolis-road">Indy Road</option>
      </select>
      <button id="switchTrackBtn" style="margin-left: 10px; padding: 5px 15px; border-radius: 4px; border: 1px solid #555; background-color: #444; color: #ffffff; cursor: pointer;">Switch Track</button>
    </div>
    
    <div id="trackContainer" style="width: 100%; height: 600px; border: 5px solid #ff0000; border-radius: 8px; background-color: #1a1a1a; overflow: hidden; box-shadow: 0 0 10px #ff0000;"></div>

    <!-- Track Info Boxes (Weather-style grid) -->
    <div class="track-info-grid weather-style-grid">
      <div class="status-group">
        <h3>Car Ahead</h3>
        <div class="status-grid">
          <div><label>Driver:</label><span id="carAheadDriver">--</span></div>
          <div><label>Car:</label><span id="carAheadCar">--</span></div>
          <div><label>Position:</label><span id="carAheadPosition">--</span></div>
          <div><label>Class Pos:</label><span id="carAheadClassPos">--</span></div>
          <div><label>Laps:</label><span id="carAheadLaps">--</span></div>
          <div><label>Last Lap:</label><span id="carAheadLastLap">--:--</span></div>
          <div><label>Best Lap:</label><span id="carAheadBestLap">--:--</span></div>
        </div>
      </div>
      <div class="status-group">
        <h3>Car Behind</h3>
        <div class="status-grid">
          <div><label>Driver:</label><span id="carBehindDriver">--</span></div>
          <div><label>Car:</label><span id="carBehindCar">--</span></div>
          <div><label>Position:</label><span id="carBehindPosition">--</span></div>
          <div><label>Class Pos:</label><span id="carBehindClassPos">--</span></div>
          <div><label>Laps:</label><span id="carBehindLaps">--</span></div>
          <div><label>Last Lap:</label><span id="carBehindLastLap">--:--</span></div>
          <div><label>Best Lap:</label><span id="carBehindBestLap">--:--</span></div>
        </div>
      </div>
      <div class="status-group">
        <h3>Your Position</h3>
        <div class="status-grid">
          <div><label>Position:</label><span id="playerPosition">--</span></div>
          <div><label>Class Pos:</label><span id="classPosition">--</span></div>
          <div><label>Laps:</label><span id="playerLaps">--</span></div>
          <div><label>Lap Pct:</label><span id="lapDistPct">--%</span></div>
        </div>
      </div>
      <div class="status-group">
        <h3>Track Legend</h3>
        <div class="status-grid">
          <div><label>üü¢ Your Car</label></div>
          <div><label>üü† Car Ahead</label></div>
          <div><label>üîµ Car Behind</label></div>
          <div><label>üü¢ Ring: Lapped Car</label></div>
          <div><label>üî¥ Ring: Lapping You</label></div>
        </div>
      </div>
      <div class="status-group">
        <h3>Session Data</h3>
        <div class="status-grid">
          <div><label>Track Name:</label><span id="sessionTrackName">--</span></div>
          <div><label>Track Length:</label><span id="sessionTrackLength">--</span></div>
          <div><label>Session Type:</label><span id="sessionType">--</span></div>
          <div><label>Session Laps:</label><span id="sessionLaps">--</span></div>
          <div><label>Session Time:</label><span id="sessionTime">--</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Resources -->
  <script src="storage-manager.js"></script>
  <script src="telemetry.js"></script>
  <script src="track-data.js"></script>
  <script src="trackmap-overlay.js"></script>
  <script src="nav.js"></script>
  
  <script>
    // Initialize Track Map when page loads
    document.addEventListener('DOMContentLoaded', function() {
      let currentTrackId = 'ring-vln'; // Default track
      
      // Wait for socket to be available from telemetry.js
      async function initTrackMap(trackId = currentTrackId) {
        if (typeof socket !== 'undefined' && socket) {
          // If trackMap already exists, we're switching tracks
          if (window.trackMap) {
            await window.trackMap.switchTrack(trackId);
            console.log(`TrackMapOverlay switched to: ${trackId}`);
          } else {
            // Initial initialization
            window.trackMap = new TrackMapOverlay(socket, 'trackContainer', trackId);
            console.log('TrackMapOverlay initialized successfully');
          }
          currentTrackId = trackId;
        } else {
          console.warn('Socket not ready, retrying track map initialization...');
          setTimeout(() => initTrackMap(trackId), 500);
        }
      }
      
      // Set up track selector event listeners
      const trackSelector = document.getElementById('trackSelector');
      const switchTrackBtn = document.getElementById('switchTrackBtn');
      
      // Load saved track preference
      const savedTrackId = localStorage.getItem('selectedTrack');
      if (savedTrackId && savedTrackId !== currentTrackId) {
        trackSelector.value = savedTrackId;
        currentTrackId = savedTrackId;
      }
      
      // Handle track switching
      function switchTrack() {
        const selectedTrackId = trackSelector.value;
        if (selectedTrackId !== currentTrackId) {
          console.log(`üèÅ User switching track from ${currentTrackId} to ${selectedTrackId}`);
          initTrackMap(selectedTrackId);
          
          // Save track preference
          localStorage.setItem('selectedTrack', selectedTrackId);
        }
      }
      
      switchTrackBtn.addEventListener('click', switchTrack);
      
      // Also allow switching on dropdown change (for convenience)
      trackSelector.addEventListener('change', function() {
        if (this.value !== currentTrackId) {
          switchTrack();
        }
      });
      
      // Start initialization with current/saved track
      initTrackMap(currentTrackId);
    });
  </script>
</body>
</html>
