<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Endurance Planner</title>
  <!-- External Dependencies -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="staticplanner.css">
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <button onclick="location.href='index.html'">Strategy</button>
    <button onclick="location.href='inputs.html'">Inputs</button>
    <button onclick="location.href='planner.html'">Endurance</button>
    <div id="refreshRate">Static Planner</div>
  </div>

  <!-- Race Parameters Section - Structured like other pages -->
  <div class="telemetry-block">
    <h2>Race Parameters</h2>
    <div class="input-group">
      <div>
        <label for="tankCapacity">Fuel Tank Capacity (L):</label>
        <input type="number" id="tankCapacity" value="104" step="0.1">
      </div>
      <div>
        <label for="fuelPerLap">Fuel Per Lap (L):</label>
        <input type="number" id="fuelPerLap" value="2.8" step="0.1">
      </div>
      <div>
        <label for="avgLapTime">Average Lap Time (sec):</label>
        <input type="number" id="avgLapTime" value="90" step="0.1">
      </div>
      <div>
        <label for="raceDuration">Race Duration (min):</label>
        <input type="number" id="raceDuration" value="60" step="5">
      </div>
      <div>
        <label for="safetyMargin">Safety Margin (%):</label>
        <input type="number" id="safetyMargin" value="5" min="0" max="20" step="1">
        <div class="input-hint">Amount of fuel to reserve (% of tank)</div>
      </div>
    </div>
  </div>
    
  <!-- Current Status Section -->
  <div class="telemetry-block">
    <h2>Current Status</h2>
    <div class="input-group">
      <div>
        <label for="currentFuelLevel">Current Fuel Level (L):</label>
        <input type="number" id="currentFuelLevel" value="104" step="0.1">
      </div>
      <div>
        <label for="currentLap">Current Lap:</label>
        <input type="number" id="currentLap" value="1" step="1">
      </div>
      <div>
        <label for="currentStintNumber">Current Stint:</label>
        <input type="number" id="currentStintNumber" value="1" step="1">
      </div>
      <div>
        <label for="pitStopTime">Pit Stop Duration (sec):</label>
        <input type="number" id="pitStopTime" value="45" step="1">
      </div>
    </div>
    
    <div class="button-group">
      <button id="calculateButton">Calculate Stint Plan</button>
      <button id="resetButton">Reset to Defaults</button>
    </div>
  </div>

  <!-- Endurance Planner Content -->
  <div class="telemetry-block">
    <h2>Endurance Planner Results</h2>
    
    <!-- Race Info Summary -->
    <div class="race-info-grid">
      <div><label>Race Time Remaining:</label><span id="countdown-timer">--:--:--</span></div>
      <div><label>Next Pit Stop In:</label><span id="next-pitstop-time">--:--:--</span></div>
      <div><label>Current Stint:</label><span id="current-stint-display">--</span></div>
      <div><label>Stint Duration:</label><span id="live-stint-duration-display">--:--:--</span></div>
      <div><label>Laps Per Stint:</label><span id="live-laps-per-stint-display">--</span></div>
      <div><label>Total Pit Stops:</label><span id="live-pit-stops-display">--</span></div>
    </div>
  </div>
  
  <!-- Calculation Variables Section -->
  <div class="telemetry-block">
    <h2>Calculation Variables <span class="info-badge" title="These values are used in the stint calculations">ℹ️</span></h2>
    <div class="race-info-grid calculation-variables">
      <div>
        <label>Fuel Per Lap:</label>
        <span id="fuel-per-lap">--</span>
        <div class="tooltip">Defined in the input form above</div>
      </div>
      <div>
        <label>Lap Time:</label>
        <span id="avg-lap-time">--</span>
        <div class="tooltip">Defined in the input form above</div>
      </div>
      <div>
        <label>Tank Capacity:</label>
        <span id="max-fuel">--</span>
      </div>
      <div>
        <label>Current Fuel Level:</label>
        <span id="current-fuel">--</span>
      </div>
      <div>
        <label>Pit Stop Duration:</label>
        <span id="pit-stop-time">--</span>
      </div>
      <div>
        <label>Safety Margin:</label>
        <span id="safety-margin-display">--</span>
        <div class="tooltip">Amount of fuel reserved for safety</div>
      </div>
    </div>
  </div>
  
  <!-- Stint Table -->
  <div class="telemetry-block">
    <h2>Stint Plan</h2>
    <div id="live-table">
      <table id="live-stint-table" class="stint-table">
        <thead>
          <tr>
            <th>Stint</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Stint Duration</th>
            <th>Stint Laps</th>
            <th>Fuel Per Stint (L)</th>
          </tr>
        </thead>
        <tbody id="live-stint-table-body">
          <!-- Stint rows will be dynamically added here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // State variables for stint calculations
    let stintData = [];
    let tankCapacity = 104;
    let fuelPerLap = 2.8;
    let avgLapTime = 90;
    let raceDuration = 3600; // 60 minutes in seconds
    let currentFuelLevel = 104;
    let currentLap = 1;
    let currentStintNumber = 1;
    let pitStopTime = 45;
    let raceTimeRemaining = 3600;
    let nextPitStop = 0;
    let stintDuration = 0;
    let lapsPerStint = 0;
    let isPitting = false;
    let safetyMargin = 5; // Default 5% safety margin

    // Initialize the page when DOM is loaded
    document.addEventListener('DOMContentLoaded', initStaticPlanner);

    function initStaticPlanner() {
      // Set up event listeners
      document.getElementById('calculateButton').addEventListener('click', readFormValues);
      document.getElementById('resetButton').addEventListener('click', resetToDefaults);
      
      // Calculate initial stint plan with default values
      calculateStintPlan();
      updateUI();
    }

    function readFormValues() {
      // Read values from form inputs
      tankCapacity = parseFloat(document.getElementById('tankCapacity').value) || 104;
      fuelPerLap = parseFloat(document.getElementById('fuelPerLap').value) || 2.8;
      avgLapTime = parseFloat(document.getElementById('avgLapTime').value) || 90;
      raceDuration = (parseFloat(document.getElementById('raceDuration').value) || 60) * 60; // Convert minutes to seconds
      currentFuelLevel = parseFloat(document.getElementById('currentFuelLevel').value) || 104;
      currentLap = parseInt(document.getElementById('currentLap').value) || 1;
      currentStintNumber = parseInt(document.getElementById('currentStintNumber').value) || 1;
      pitStopTime = parseFloat(document.getElementById('pitStopTime').value) || 45;
      safetyMargin = parseFloat(document.getElementById('safetyMargin').value) || 5;
      
      // Update race time remaining based on current lap
      const elapsedTime = (currentLap - 1) * avgLapTime;
      raceTimeRemaining = Math.max(0, raceDuration - elapsedTime);
      
      // Recalculate stint plan with new values
      calculateStintPlan();
      updateUI();
    }

    function resetToDefaults() {
      // Reset form to default values
      document.getElementById('tankCapacity').value = 104;
      document.getElementById('fuelPerLap').value = 2.8;
      document.getElementById('avgLapTime').value = 90;
      document.getElementById('raceDuration').value = 60;
      document.getElementById('currentFuelLevel').value = 104;
      document.getElementById('currentLap').value = 1;
      document.getElementById('currentStintNumber').value = 1;
      document.getElementById('pitStopTime').value = 45;
      document.getElementById('safetyMargin').value = 5;
      
      // Reset to default values
      tankCapacity = 104;
      fuelPerLap = 2.8;
      avgLapTime = 90;
      raceDuration = 3600;
      currentFuelLevel = 104;
      currentLap = 1;
      currentStintNumber = 1;
      pitStopTime = 45;
      raceTimeRemaining = 3600;
      safetyMargin = 5;
      
      // Recalculate stint plan with default values
      calculateStintPlan();
      updateUI();
    }

    // This function formats time from seconds into HH:MM:SS format
    function formatTime(totalSeconds) {
      if (totalSeconds === undefined || totalSeconds === null) return "--:--:--";
      
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = Math.floor(totalSeconds % 60);
      const pad = (num) => String(num).padStart(2, '0');
      return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    // Calculate the stint plan based on current values
    function calculateStintPlan() {
      // Don't calculate if we don't have valid data yet
      if (fuelPerLap <= 0 || avgLapTime <= 0 || tankCapacity <= 0) {
        // Set some reasonable defaults if we don't have real data
        fuelPerLap = fuelPerLap || 2.8;
        avgLapTime = avgLapTime || 90;
        tankCapacity = tankCapacity || 104;
      }
      
      // Ensure safety margin is within reasonable bounds
      safetyMargin = Math.max(0, Math.min(20, safetyMargin));
      
      // Clear previous stint data
      stintData = [];
      
      // Calculate basic stint values
      const fuelPerStint = tankCapacity * (1 - (safetyMargin / 100)); // Using user-defined safety margin
      lapsPerStint = Math.floor(fuelPerStint / fuelPerLap);
      stintDuration = lapsPerStint * avgLapTime;
      
      // Use the race time remaining if available, otherwise use a default
      const estimatedRaceDuration = raceTimeRemaining > 0 ? raceTimeRemaining : 3600;
      
      // Calculate total number of stints needed
      const raceLaps = Math.ceil(estimatedRaceDuration / avgLapTime);
      const totalStints = Math.ceil(raceLaps / lapsPerStint);
      
      // Determine current race progress based on inputs
      let raceElapsedTime = raceDuration - raceTimeRemaining;
      
      // Generate stint data starting from current race state
      let currentTime = raceElapsedTime;
      
      // Account for current stint progress
      let stintOffset = 0;
      if (currentStintNumber > 1) {
        stintOffset = currentStintNumber - 1;
      }
      
      // Calculate fuel remaining in current stint
      let currentStintFuelRemaining = currentFuelLevel;
      
      // Calculate laps remaining in current stint
      const currentStintLapsRemaining = Math.floor(currentStintFuelRemaining / fuelPerLap);
      
      // Calculate time remaining in current stint
      const currentStintTimeRemaining = currentStintLapsRemaining * avgLapTime;
      
      // Generate stint data for remaining race
      for (let i = currentStintNumber; i <= totalStints + stintOffset; i++) {
        // For current stint, use actual remaining time and fuel
        let stintStartTime = currentTime;
        let stintEndTime, actualStintDuration, actualLaps, fuelUsed;
        
        if (i === currentStintNumber && currentStintTimeRemaining > 0) {
          // Current active stint
          stintEndTime = stintStartTime + currentStintTimeRemaining;
          actualStintDuration = currentStintTimeRemaining;
          actualLaps = currentStintLapsRemaining;
          fuelUsed = currentStintFuelRemaining;
        } else {
          // Future stints
          stintEndTime = Math.min(stintStartTime + stintDuration, estimatedRaceDuration);
          actualStintDuration = stintEndTime - stintStartTime;
          actualLaps = Math.floor(actualStintDuration / avgLapTime);
          fuelUsed = actualLaps * fuelPerLap;
        }
        
        // Add to stint data if there's any time in this stint
        if (actualStintDuration > 0) {
          stintData.push({
            stintNumber: i,
            startTime: stintStartTime,
            endTime: stintEndTime,
            stintDuration: actualStintDuration,
            laps: actualLaps,
            fuel: typeof fuelUsed === 'number' ? fuelUsed.toFixed(2) + ' L' : fuelUsed
          });
          
          currentTime = stintEndTime;
          
          // Add pit stop after stint (except for the last stint)
          if (currentTime < estimatedRaceDuration && i < totalStints + stintOffset) {
            const pitStartTime = currentTime;
            const pitEndTime = pitStartTime + pitStopTime;
            
            stintData.push({
              stintNumber: `PIT ${i}`,
              startTime: pitStartTime,
              endTime: pitEndTime,
              stintDuration: pitStopTime,
              laps: "—",
              fuel: "Refueling"
            });
            
            currentTime = pitEndTime;
          }
        }
        
        // If we've reached race duration, stop adding stints
        if (currentTime >= estimatedRaceDuration) break;
      }
      
      // Calculate next pit stop time
      if (stintData.length > 0) {
        // Find the next pit stop
        const currentStintIndex = stintData.findIndex(stint => 
          !String(stint.stintNumber).startsWith('PIT') && 
          stint.stintNumber === currentStintNumber
        );
        
        if (currentStintIndex !== -1 && currentStintIndex < stintData.length - 1) {
          // Next pit stop is the end time of the current stint
          nextPitStop = stintData[currentStintIndex].endTime - raceElapsedTime;
        } else {
          // No more pit stops
          nextPitStop = 0;
        }
      } else {
        nextPitStop = 0;
      }
    }

    // Update UI with calculation results
    function updateUI() {
      // Update race info
      document.getElementById('countdown-timer').textContent = formatTime(raceTimeRemaining);
      document.getElementById('next-pitstop-time').textContent = formatTime(nextPitStop);
      document.getElementById('current-stint-display').textContent = currentStintNumber;
      document.getElementById('live-stint-duration-display').textContent = formatTime(stintDuration);
      document.getElementById('live-laps-per-stint-display').textContent = lapsPerStint;
      document.getElementById('live-pit-stops-display').textContent = Math.max(0, stintData.filter(s => String(s.stintNumber).startsWith('PIT')).length);
      
      // Update calculation variables
      document.getElementById('fuel-per-lap').textContent = fuelPerLap.toFixed(2) + " L";
      document.getElementById('avg-lap-time').textContent = formatTime(avgLapTime);
      document.getElementById('max-fuel').textContent = tankCapacity.toFixed(1) + " L";
      document.getElementById('current-fuel').textContent = currentFuelLevel.toFixed(1) + " L";
      document.getElementById('pit-stop-time').textContent = formatTime(pitStopTime);
      document.getElementById('safety-margin-display').textContent = safetyMargin + "% (" + (tankCapacity * safetyMargin / 100).toFixed(1) + " L)";

      // Update stint table
      const tbody = document.getElementById('live-stint-table-body');
      tbody.innerHTML = '';
      
      if (stintData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No stint data available</td></tr>';
      } else {
        stintData.forEach(stint => {
          const stintRow = document.createElement('tr');
          const isPitRow = String(stint.stintNumber).startsWith('PIT');

          // Apply appropriate classes based on stint type and status
          if (isPitRow) {
            stintRow.classList.add('pit-row');
            if (isPitting && stint.stintNumber === `PIT ${currentStintNumber}`) {
              stintRow.classList.add('current-pit');
            }
          } else {
            stintRow.classList.add('stint-row');
            if (!isPitting && stint.stintNumber === currentStintNumber) {
              stintRow.classList.add('current-stint');
            }
          }

          stintRow.innerHTML = `
              <td>${stint.stintNumber}</td>
              <td>${formatTime(stint.startTime)}</td>
              <td>${formatTime(stint.endTime)}</td>
              <td>${formatTime(stint.stintDuration)}</td>
              <td>${stint.laps}</td>
              <td>${stint.fuel}</td>
          `;
          tbody.appendChild(stintRow);
        });
      }
    }
  </script>
</body>
</html>
