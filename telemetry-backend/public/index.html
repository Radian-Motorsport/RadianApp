<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telemetry Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .dimmed {
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    body {
      background-color: #121212;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    #fuelGaugeContainer {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      width: 300px;
      text-align: center;
    }

    #fuelGaugeContainer label {
      font-size: 1.2rem;
      margin-bottom: 10px;
      display: block;
    }

    #fuelGauge {
      width: 100%;
      height: 30px;
      appearance: none;
      background: #333;
      border-radius: 5px;
    }

    #fuelGauge::-webkit-progress-bar {
      background-color: #222;
      border-radius: 5px;
    }

    #fuelGauge::-webkit-progress-value {
      background-color: #00ff00;
      border-radius: 5px;
    }

    #fuelGauge::-moz-progress-bar {
      background-color: #00ff00;
      border-radius: 5px;
    }

    #fuelValue {
      margin-top: 10px;
      font-size: 1rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div id="streamingStatus" style="font-weight: bold; margin-bottom: 10px;">
  Live: —
  </div>
  <div id="fuelGaugeContainer">
    <label for="fuelGauge">Fuel Level</label>
    <progress id="fuelGauge" value="0" max="100"></progress>
    <div id="fuelValue">0%</div>
    <div id="fuelPerLap">Fuel Used Last Lap: --</div>
    <div id="fuelAvg">3-Lap Avg: --</div>
  </div>
  <div id="teamLapDisplay" style="margin-top: 20px; font-size: 1rem; color: #ccc;">
    Team Car Lap: —
  </div>
  <div id="bufferStatus" style="margin-top: 10px; font-size: 1rem; color: #888;">
  —
  </div>


  <script>
  const socket = io('https://radianapp.onrender.com');

  function updateFuelGauge(level) {
    const gauge = document.getElementById('fuelGauge');
    const valueDisplay = document.getElementById('fuelValue');
    const fuel = Number(level).toFixed(1);
    gauge.value = fuel;
    valueDisplay.textContent = `${fuel}%`;
  }

  let lastLapCompleted = -1;
  let fuelAtLapStart = null;
  let fuelUsageHistory = [];
  let currentLap = 0;
  let lastTeamLap = null;
  let bufferedData = null;
  let lapEntryPoint = null;
  let bufferFrozen = true;
  let driverWasOnTrack = false;

  const MIN_LAPS_FOR_VALID_DATA = 2;

  socket.on('telemetry', (data) => {
    const values = data?.values;
    const carIdx = values?.PlayerCarIdx;
    const teamLap = values?.CarIdxLapCompleted?.[carIdx];
    const isOnTrack = values?.IsOnTrack;
    const panel = document.getElementById('fuelGaugeContainer');

    document.getElementById('teamLapDisplay').textContent = `Team Car Lap: ${teamLap}`;

    // 🔁 Detect driver exit
    if (!isOnTrack && driverWasOnTrack) {
      bufferFrozen = true;
      lapEntryPoint = null;
      lastTeamLap = null;
      document.getElementById('bufferStatus').textContent = 'Waiting for driver…';
      document.getElementById('fuelPerLap').textContent = 'Fuel Used Last Lap: --';
      document.getElementById('fuelAvg').textContent = '3-Lap Avg: --';
      panel.classList.add('dimmed');
      driverWasOnTrack = false;
      return;
    }

    // 🔁 Detect driver entry
    if (isOnTrack && !driverWasOnTrack) {
      lapEntryPoint = teamLap;
      bufferFrozen = true;
      document.getElementById('bufferStatus').textContent = 'Waiting for next lap…';
      panel.classList.add('dimmed');
      driverWasOnTrack = true;
      return;
    }

    // 🔁 Lap-based buffer unlock
    if (isOnTrack && !bufferFrozen && teamLap > lastTeamLap) {
      lastTeamLap = teamLap;
      bufferedData = data;
      document.getElementById('bufferStatus').textContent = 'Live telemetry';
    }

    // 🔁 Unlock buffer after 2 laps
    if (isOnTrack && bufferFrozen && lapEntryPoint !== null && teamLap >= lapEntryPoint + 2) {
      bufferFrozen = false;
      lastTeamLap = teamLap;
      bufferedData = data;
      document.getElementById('bufferStatus').textContent = 'Live telemetry';
    }

    // 🔁 Use buffered data for display
    const safeValues = bufferedData?.values;
    if (!safeValues) return;

    const fuelLevel = safeValues.FuelLevel ?? 0;
    const lapCompleted = safeValues.LapCompleted;
    const fuel = safeValues.FuelLevel;

    currentLap = lapCompleted;
    const driverReady = currentLap >= MIN_LAPS_FOR_VALID_DATA;

    if (driverReady) {
      panel.classList.remove('dimmed');
      updateFuelGauge(fuelLevel);

      if (lapCompleted !== lastLapCompleted && lapCompleted !== -1) {
        if (fuelAtLapStart !== null) {
          const fuelUsed = fuelAtLapStart - fuel;
          if (fuelUsed >= 0 && isFinite(fuelUsed)) {
            fuelUsageHistory.push(fuelUsed);
            if (fuelUsageHistory.length > 3) fuelUsageHistory.shift();
            const avgFuelUsed = fuelUsageHistory.reduce((a, b) => a + b, 0) / fuelUsageHistory.length;
            document.getElementById('fuelPerLap').textContent = `Fuel Used Last Lap: ${fuelUsed.toFixed(2)} L`;
            document.getElementById('fuelAvg').textContent = `3-Lap Avg: ${avgFuelUsed.toFixed(2)} L`;
          }
        }
        fuelAtLapStart = fuel;
        lastLapCompleted = lapCompleted;
      }
    } else {
      panel.classList.add('dimmed');
    }
  });

  socket.on('currentBroadcaster', (info) => {
    document.getElementById('streamingStatus').textContent =
      `Live: ${info.driver} (Session ${info.sessionId})`;
  });

  socket.on('telemetry', (data) => {
    const isOnTrack = data?.values?.IsOnTrack;
    if (isOnTrack === false) {
      document.getElementById('streamingStatus').textContent = 'Live: —';
    }
  });
</script>


</body>
</html>
